<html >
<head>
	<title>Index</title>
	
	<!-- //added this line because $ was not defined -->


    <script type="text/javascript" src="./bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="./bower_components/angular/angular.min.js"></script>
    <script type="text/javascript" src="./bower_components/angular-route/angular-route.min.js"></script>
	<script type="text/javascript" src="chessboardjs-0.3.0/js/chessboard-0.3.0.js"></script>
	<link rel="stylesheet" type="text/css" href="chessboardjs-0.3.0/css/chessboard-0.3.0.css">

	

	<script type="text/javascript">

	var chessApp = angular.module("chessApp", ["ngRoute"]);


	chessApp.config(function ($routeProvider) {
		$routeProvider
		.when("/", {
			templateUrl: "chessboardjs-0.3.0/partials/new.html"
		})
		.when("/forks", {
			templateUrl: "chessboardjs-0.3.0/partials/forks.html"
		})
		.when("/skewers", {
			templateUrl: "chessboardjs-0.3.0/partials/skewers.html"
		})
		.when("/discovered", {
			templateUrl: "chessboardjs-0.3.0/partials/discovered.html"
		})
		.when("/pins", {
			templateUrl: "chessboardjs-0.3.0/partials/pins.html"
		})
		.when("/endgames", {
			templateUrl: "chessboardjs-0.3.0/partials/endgames.html"
		})
		.otherwise({
			redirectTo: "/"
		})
	})

	//the PuzzleFactory handles the chess boards saved by user
	chessApp.factory("PuzzleFactory", function ($http) {
		var factory = {};
		//puzzles from the db
		var puzzles = [];

		factory.index = function(callback) {
			$http.get("/puzzles").success(function (output) {
				// console.log("factory: index")
				// console.log( output)
				puzzles = output
				callback(puzzles);
			})
		}

		factory.create = function(callback) {
			//add "data" parameter?
			$http.post("/puzzles").success(function (output) {
				console.log("factory:create puzzle")
			})
			callback()
		}

		return factory;
	})

	//this controller is for creating new puzzle on new.html
	chessApp.controller("PuzzleController", function ($scope, PuzzleFactory) {

		newPuzzle = {};
		var fenfen;
		var solutionFen;

		PuzzleFactory.index(function (data) {
			$scope.puzzles = data;
		})

		$scope.create = function() {

			//
			// console.log("Current position as an Object:");
			// newPuzzle.positionObj = newPuzzleBoard.position()
			// console.log(newPuzzle.positionObj);

			// newPuzzle.fen = newPuzzleBoard.fen()
			// console.log("Current position as a FEN string:");
			// console.log(newPuzzle.fen);

			// removed this because it was creating duplicates
			// PuzzleFactory.create($scope.newPuzzle, function() {

			// })
		}

	//jquery stuff for saving new puzzle in new.html
	$(document).ready(function(){

		
	var newPuzzleBoard = ChessBoard('newPuzzleBoard', {
	  draggable: true,
	  dropOffBoard: 'trash',
	  sparePieces: true
	});

	$('#startBtn').on('click', newPuzzleBoard.start);
	$('#clearBtn').on('click', newPuzzleBoard.clear);


	//getPositionBtn should show the starting fen string to the user on new.html
	//getSolutionBtn should show the solution fen string to the user on new.html
	$("#getPositionBtn").on("click", showStartingFen);

	function showStartingFen(){
		$scope.fenfen = newPuzzleBoard.fen()
		// console.log($scope.fenfen)
		$("#showStart").val($scope.fenfen)
	};
	// console.log($scope.fenfen)


	$("#getSolutionBtn").on("click", showSolutionFen);
	function showSolutionFen(){
		$scope.solutionFen = newPuzzleBoard.fen()
		// console.log($scope.solutionFen)
		$("#showSolution").val($scope.solutionFen)
	}
	// console.log($scope.solutionFen)

	//i want this button to create the FEN & positionObj
	//then call the puzzlecontroller create function 
	$('#savePuzzleBtn').on('click', clickSavePuzzle);

	function clickSavePuzzle() {

		
		// newPuzzle.positionObj = newPuzzleBoard.position()
		// console.log("Current position as an Object:");
		// console.log(newPuzzle.positionObj);

		// $scope.fenfen = newPuzzleBoard.fen()
		// console.log("Current position as a FEN string:");
		// console.log(fenfen);
		
		$scope.solutionFen = $("#solution").val()
		//show user that starting position and solution were saved

		var request = $.ajax({
			url: "/puzzles",
			method: "POST",
			data: {
				fen: $("#showStart").val(),
				tactic: $("#tactic").val(),
				turn: $("#turn").val(),
				solution: $("#showSolution").val()
			},
			datatype: "html"
		});

		// console.log(request.data)
		// console.log(request)

		request.done(function () {
			console.log("Success")
		});

		request.fail(function (jqXHR, textStatus) {
			alert("I'm sorry. Request failed: " + textStatus);
		});
	}//closes clickGetPositionBtn
	})//closes document.ready for new.html
	})//closes puzzle controller
	

	chessApp.controller("forksController", function ($scope, PuzzleFactory) {

		$scope.forks = [];
		$scope.puzzles = [];

		

		PuzzleFactory.index(function (data) {
			$scope.puzzles = data;

			for(i in $scope.puzzles){
				if($scope.puzzles[i].tactic == "fork"){

					$scope.forks.push($scope.puzzles[i]);

				}
			}

			$(document).ready(function () {
				
				// get the $$hashkey of object fork in forks array
				// use the $$hashkey for the index to retrieve fen
				// set initial board to first tactic in array
				var board = ChessBoard("board", {

					draggable: true,
					position:$scope.forks[0].fen
				})

				//had to move this above to get it to work 
				checkAnswer = function (){

					return board.fen();
					
				}



				getForkIndex = function (){

					return $("#forkIndex").val();

				}
				//user selects the puzzle
				//index isn't 
				$("#showTacticBtn").click(getForkIndex, function (){

					//removes div result from submiting answer
					$(".correct").addClass("hidden")
					$(".wrong").addClass("hidden")

					$scope.index = getForkIndex();
					// console.log("index inside function: ", index)

					config = {
						draggable: true,
						position: $scope.forks[$scope.index].fen,
				
					}
					// console.log ($scope.forks[index].turn)

					//this updates puzzle, but upon refreshing...the board reverts to above
					board = ChessBoard("board", config)

					//user moves pieces, checks answer
					//answer is captured into $scope.userAnswer
					$("#checkAnswer").click(checkAnswer, function (){

						// was consistent with addClass and removeClass to prevent
						// the div from staying
						// $(".correct").hide()
						
						$(".correct").addClass("hidden")
						$(".wrong").addClass("hidden")

						$scope.userAnswer = checkAnswer();
						
						console.log($scope.userAnswer);
						console.log($scope.forks[$scope.index].solution)
						
						if($scope.userAnswer == $scope.forks[$scope.index].solution){
							console.log("yay!")
							$(".correct").removeClass("hidden");
						} else {
							// $(".wrong").show();
							$(".wrong").removeClass("hidden");
						}
					})





				})
			}) //closes document ready
		}) //closes puzzle factory
		}) //closes forksController

		chessApp.controller("pinsController", function ($scope, PuzzleFactory) {

			$scope.pins = [];
			$scope.puzzles = [];
			

			PuzzleFactory.index(function (data) {
				$scope.puzzles = data;

				for(i in $scope.puzzles){
					if($scope.puzzles[i].tactic == "pin"){

						$scope.pins.push($scope.puzzles[i]);

					}
				}
			
				$(document).ready(function () {

					var board = ChessBoard("board", {position: $scope.pins[0].fen} )

					getPinIndex = function () {
						
						return $("#pinIndex").val()
					}

					$("#showTacticBtn").click(getPinIndex, function () {
						
						var index = getPinIndex();
						board = ChessBoard("board", {position: $scope.pins[index].fen} )
					})
				})
			})//closes PuzzleFactory.index
		})//closee PinsController

		chessApp.controller("skewersController", function ($scope, PuzzleFactory) {

			$scope.skewers = [];
			$scope.puzzles = [];

			PuzzleFactory.index(function (data) {
				$scope.puzzles = data;

				for(i in $scope.puzzles){
					if($scope.puzzles[i].tactic == "skewer"){

						$scope.skewers.push($scope.puzzles[i]);

					}
				}

				$(document).ready(function () {

					var board = ChessBoard("board", {position: $scope.skewers[0].fen})

					getSkewerIndex = function () {

						return $("#skewerIndex").val()
					}

					$("#showTacticBtn").click(getSkewerIndex, function () {

						var index = getSkewerIndex();
						board = ChessBoard("board", {position: $scope.skewers[index].fen})
					})
				})
			})
		})

		chessApp.controller("discoveriesController", function ($scope, PuzzleFactory) {

			$scope.discoveries = [];
			$scope.puzzles = [];

			PuzzleFactory.index(function (data) {
				$scope.puzzles = data;

				for(i in $scope.puzzles){
					if($scope.puzzles[i].tactic == "skewer"){

						$scope.discoveries.push($scope.puzzles[i]);

					}
				}

				$(document).ready(function () {

					var board = ChessBoard("board", { position: $scope.discoveries[0].fen} )

					getDiscoveryIndex = function () {

						return $("#discoveryIndex").val()
					}

					$("#showTacticBtn").click(getDiscoveryIndex, function () {

						var index = getDiscoveryIndex();
						board = ChessBoard("board", { position: $scope.discoveries[index].fen})
					})
				})

			})//closed PuzzleFactory
		})


	</script>
	
</head>
<body ng-app="chessApp">


<div>

	<a href="#/new">Create Puzzle</a> | <a href="#/forks">forks</a> | <a href="#/pins">pins</a> | <a href="#/skewers">skewers</a> | <a href="#/discovered">discovered attack</a> | <a href="#/endgames">endgame simulation</a><br>
	<br><div ng-view=""></div>

</div>

</body>



</html>

